"use strict";const{app:c,BrowserWindow:h,Menu:S,globalShortcut:k}=require("electron"),f=require("path"),{SerialPort:I}=require("serialport"),{spawn:b}=require("child_process");let d=null,l=null;function T(){const i=f.join(__dirname,"../server/api.js");l=b("node",[i],{stdio:"pipe",detached:!1}),l.stdout.on("data",e=>{console.log("后端服务输出:",e.toString())}),l.stderr.on("data",e=>{console.error("后端服务错误:",e.toString())}),l.on("close",e=>{console.log("后端服务已关闭，退出码:",e)}),l.on("error",e=>{console.error("启动后端服务失败:",e)}),console.log("后端服务已启动")}function E(){l&&(console.log("正在关闭后端服务..."),l.kill("SIGTERM"),l=null)}let p=null;function x(){p||(p=setInterval(()=>{const i=Math.floor(Math.random()*10000001);h.getAllWindows().forEach(e=>{e.webContents.send("serialport-data",`${i}\r
`)})},300))}let n="",u=null,w=0,R=0;function v(){c.on("browser-window-created",(i,e)=>{e.rfidListenerRegistered||(e.rfidListenerRegistered=!0,e.webContents.on("before-input-event",(m,s)=>{if(s.type!=="keyDown")return;const t=Date.now();if(/^[0-9A-Fa-f]$/.test(s.key)){const r=t-w;w=t,n.length===0&&(R=t),(n.length===0||r<50)&&(n+=s.key.toUpperCase(),u&&clearTimeout(u),u=setTimeout(()=>{n=""},500))}else if(s.key==="Enter"){if(n.length>0){console.log("RFID读到卡号:",n);const r=t-R;console.log("长度:",n.length,"时长:",r),n.length>=6&&r>300?(console.log("RFID刷卡识别成功:",n),h.getAllWindows().forEach(_=>{_.webContents.send("rfid-data",n)})):console.log("普通键盘输入，不处理:",n),n=""}u&&(clearTimeout(u),u=null)}}))})}const{ipcMain:M}=require("electron");let a="",g=null;M.on("open-serialport",i=>{if(process.env.MOCK_SERIAL==="1"){x();return}d&&d.isOpen||(d=new I({path:"COM3",baudRate:9600,autoOpen:!1},e=>{if(e){i.sender.send("serialport-error",e.message);return}}),d.on("data",e=>{const m=e.toString();console.log("串口收到数据:",m,"原始字节:",Array.from(e)),a+=m,g&&clearTimeout(g);const s=a.replace(/[\x02\x03]/g,"");console.log("清理后的缓冲区:",JSON.stringify(s));let t=s.match(/([+-]\d{9})(?![0-9])/g);if(t||(t=s.match(/([+-]\d{8}[A-Z])/g)),t){const r=t[t.length-1];console.log("发送完整数据包:",r),o.webContents.send("serialport-data",r),a=""}else g=setTimeout(()=>{if(a.length>0){console.log("超时发送缓冲区数据:",a);const r=a.replace(/[\x02\x03]/g,"");r.length>0&&o.webContents.send("serialport-data",r),a=""}},100)}),d.on("error",e=>{i.sender.send("serialport-error",e.message)}),d.open(e=>{if(e){i.sender.send("serialport-error",e.message);return}}))});c.whenReady().then(()=>{v()});let o=null;function V(){if(o){o.isMinimized()&&o.restore(),process.env.VITE_DEV_SERVER_URL?o.loadURL(process.env.VITE_DEV_SERVER_URL+"/#/home"):o.loadFile(f.join(__dirname,"../dist/index.html"),{hash:"/home"}),o.maximize(),o.focus();return}o=new h({width:1200,height:800,minWidth:800,minHeight:600,resizable:!0,maximizable:!0,fullscreenable:!0,autoHideMenuBar:!0,frame:!0,show:!1,icon:f.join(__dirname,"logo.ico"),webPreferences:{nodeIntegration:!0,contextIsolation:!1}}),S.setApplicationMenu(null),process.env.VITE_DEV_SERVER_URL?o.loadURL(process.env.VITE_DEV_SERVER_URL+"/#/home"):o.loadFile(f.join(__dirname,"../dist/index.html"),{hash:"/home"}),o.once("ready-to-show",()=>{o.show(),o.maximize()}),o.on("maximize",()=>{console.log("Window maximized")}),o.on("unmaximize",()=>{console.log("Window unmaximized")}),o.on("resize",()=>{console.log("Window resized")}),o.on("closed",()=>{o=null,c.quit()})}c.whenReady().then(()=>{T(),V()});c.on("window-all-closed",()=>{E(),c.quit()});c.on("before-quit",()=>{E()});
